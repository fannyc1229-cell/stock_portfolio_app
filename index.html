<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StockZen | å€‹äººè³‡ç”¢ç®¡ç†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3ff6; }
        
        /* è‡ªå®šç¾©æ»¾å‹•æ¢ */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }

        /* Chart Container */
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        /* éš±è—æ•¸å­—è¼¸å…¥æ¡†çš„ç®­é ­ */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* å‹•ç•« */
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
    <!-- Chosen Palette: Slate (Sidebar) + White (Content) + Red/Green (Indicators) -->
    <!-- Application Structure Plan: Dashboard layout with Sidebar for navigation (desktop) / Bottom summary (mobile). 
         Central Dashboard shows Net Worth, Day Change (simulated), and Allocation.
         Holdings section allows CRUD operations. 
         Data fetching logic uses Google Search Grounding with manual override fallback. 
         New AI analysis features are integrated into the dashboard (Portfolio Analysis) and the holdings list (Stock Summary) using dedicated modals. -->
    <!-- Visualization & Content Choices: 
         - Net Worth Card: Big number, key goal.
         - Holdings Table: Detailed list with Sparkline-like P&L indicators and new AI analysis trigger.
         - Allocation Chart: Pie Chart (Chart.js) to show diversification.
         - Interaction: Modals for adding assets, manual price entry, and AI analysis results. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
</head>
<body class="text-gray-800 h-screen flex overflow-hidden">

    <!-- æ¡Œé¢å´é‚Šæ¬„ / æ‰‹æ©Ÿç½®åº•å°èˆª (ç°¡åŒ–ç‚ºå´é‚Šæ¬„æ¨¡å¼) -->
    <aside class="hidden md:flex md:flex-col w-64 bg-slate-900 text-white transition-all duration-300 z-10">
        <div class="p-6 border-b border-slate-800 flex items-center justify-between">
            <h1 class="text-2xl font-bold tracking-tight">StockZen</h1>
            <span class="text-xs bg-slate-700 px-2 py-1 rounded text-slate-300">v1.0</span>
        </div>
        <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
            <a href="#" class="flex items-center space-x-3 px-4 py-3 bg-slate-800 rounded-lg text-white shadow-sm">
                <span class="text-xl">ğŸ“Š</span>
                <span class="font-medium">å„€è¡¨æ¿</span>
            </a>
            <div class="mt-8 px-4 text-xs font-semibold text-slate-500 uppercase tracking-wider">è³‡ç”¢ç®¡ç†</div>
            <button onclick="openAddModal()" class="w-full mt-2 flex items-center space-x-3 px-4 py-3 text-slate-400 hover:bg-slate-800 hover:text-white rounded-lg transition-colors text-left">
                <span class="text-xl">â•</span>
                <span class="font-medium">æ–°å¢æŒè‚¡</span>
            </button>
             <button onclick="updateData()" class="w-full mt-1 flex items-center space-x-3 px-4 py-3 text-slate-400 hover:bg-slate-800 hover:text-white rounded-lg transition-colors text-left">
                <span class="text-xl">ğŸ”„</span>
                <span class="font-medium">æ›´æ–°å ±åƒ¹</span>
            </button>
        </nav>
        <div class="p-4 border-t border-slate-800">
            <div class="flex items-center space-x-3 px-4 py-2">
                <div class="w-8 h-8 rounded-full bg-indigo-500 flex items-center justify-center text-sm font-bold">U</div>
                <div>
                    <p class="text-sm font-medium">User Portfolio</p>
                    <p class="text-xs text-slate-400">Local Storage</p>
                </div>
            </div>
        </div>
    </aside>

    <!-- ä¸»å…§å®¹å€å¡Š -->
    <div class="flex-1 flex flex-col h-screen overflow-hidden relative">
        
        <!-- æ‰‹æ©Ÿç‰ˆé ‚éƒ¨å°èˆª -->
        <header class="md:hidden bg-slate-900 text-white p-4 flex justify-between items-center shadow-md z-20">
            <h1 class="text-xl font-bold">StockZen</h1>
            <button onclick="openAddModal()" class="text-2xl focus:outline-none">â•</button>
        </header>

        <!-- æ»¾å‹•å…§å®¹å€åŸŸ -->
        <main class="flex-1 overflow-y-auto p-4 md:p-8 relative">
            
            <!-- é ‚éƒ¨è³‡è¨Šå¡ç‰‡ -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 fade-in">
                <!-- ç¸½è³‡ç”¢ -->
                <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 flex flex-col justify-between relative overflow-hidden">
                    <div class="absolute right-0 top-0 p-4 opacity-5 text-6xl">ğŸ’°</div>
                    <div>
                        <p class="text-sm font-medium text-gray-500 mb-1">ç¸½è³‡ç”¢æ·¨å€¼ (TWD)</p>
                        <h2 id="totalNetWorth" class="text-3xl font-bold text-slate-900 tracking-tight">NT$ 0</h2>
                    </div>
                    <div class="mt-4 flex items-center text-sm">
                        <span class="text-gray-400">åŒ¯ç‡åƒè€ƒ: 1 USD â‰ˆ <span id="exchangeRateDisplay">32.5</span> TWD</span>
                    </div>
                </div>

                <!-- ç¸½æç›Š -->
                <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 flex flex-col justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-500 mb-1">æœªå¯¦ç¾ç¸½æç›Š</p>
                        <h2 id="totalPL" class="text-3xl font-bold text-gray-900 tracking-tight">NT$ 0</h2>
                    </div>
                    <div class="mt-4">
                        <span id="totalPLPercent" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                            0.00%
                        </span>
                    </div>
                </div>

                <!-- æŠ•è³‡åˆ†ä½ˆ (åœ“é¤…åœ–) -->
                <div class="bg-white rounded-xl shadow-sm p-4 border border-gray-100 md:row-span-2 flex flex-col items-center justify-center">
                     <h3 class="text-sm font-medium text-gray-500 w-full text-left mb-2">è³‡ç”¢é…ç½®</h3>
                     <div class="chart-container">
                        <canvas id="allocationChart"></canvas>
                     </div>
                </div>

                <!-- å¸‚å ´ç‹€æ…‹ / å¿«é€Ÿæ“ä½œ (ä½”æ“šå‰©é¤˜ç©ºé–“) -->
                <div class="bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl shadow-lg p-6 text-white md:col-span-2">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-lg font-bold mb-2">å¸‚å ´å¿«è¨Š</h3>
                            <p class="text-indigo-100 text-sm mb-4">é»æ“Šã€Œæ›´æ–°å ±åƒ¹ã€ä»¥ç²å– Google æœå°‹åˆ°çš„æœ€æ–°åƒ¹æ ¼ã€‚</p>
                            <p class="text-xs text-indigo-200 opacity-80">* åƒ¹æ ¼å¯èƒ½å»¶é²ï¼Œè«‹ä»¥åˆ¸å•†ç‚ºæº–ã€‚</p>
                        </div>
                        <div class="flex flex-col space-y-2">
                            <button onclick="updateData()" class="bg-white text-indigo-600 hover:bg-indigo-50 px-4 py-2 rounded-lg text-sm font-bold shadow-sm transition-colors">
                                ç«‹å³æ›´æ–°
                            </button>
                            <!-- New LLM Feature 1: Portfolio Analysis -->
                            <button onclick="analyzePortfolio()" class="bg-pink-500 text-white hover:bg-pink-600 px-4 py-2 rounded-lg text-sm font-bold shadow-sm transition-colors flex items-center justify-center space-x-1">
                                âœ¨ çµ„åˆåˆ†æ
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æŒè‚¡åˆ—è¡¨ -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden fade-in" style="animation-delay: 0.1s;">
                <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                    <h3 class="text-lg font-bold text-gray-800">æŒè‚¡æ˜ç´°</h3>
                    <span class="text-xs text-gray-400">é»æ“Šåƒ¹æ ¼å¯æ‰‹å‹•ä¿®æ­£</span>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs text-gray-500 uppercase bg-gray-50/50">
                            <tr>
                                <th class="px-6 py-4 font-medium">æ¨™çš„</th>
                                <th class="px-6 py-4 font-medium text-right">ç¾åƒ¹</th>
                                <th class="px-6 py-4 font-medium text-right">å‡åƒ¹(æˆæœ¬)</th>
                                <th class="px-6 py-4 font-medium text-right">è‚¡æ•¸</th>
                                <th class="px-6 py-4 font-medium text-right">å¸‚å€¼ (TWD)</th>
                                <th class="px-6 py-4 font-medium text-right">æç›Š (TWD)</th>
                                <th class="px-6 py-4 font-medium text-right">æç›Š %</th>
                                <th class="px-6 py-4 font-medium text-center">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="holdingsList" class="divide-y divide-gray-100">
                            <!-- JS å°‡å¡«å……æ­¤è™• -->
                            <tr>
                                <td colspan="8" class="px-6 py-8 text-center text-gray-400">
                                    è¼‰å…¥ä¸­æˆ–å°šç„¡æŒè‚¡...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="h-20"></div> <!-- åº•éƒ¨ç•™ç™½ -->
        </main>
    </div>

    <!-- æ¨¡æ…‹æ¡†: æ–°å¢æŒè‚¡ -->
    <div id="addModal" class="fixed inset-0 bg-gray-900/50 hidden items-center justify-center z-50 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 transform transition-all scale-100 m-4">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800">æ–°å¢/ç·¨è¼¯ æŒè‚¡</h3>
                <button onclick="closeAddModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            <form id="assetForm" onsubmit="handleAssetSubmit(event)" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">è‚¡ç¥¨ä»£è™Ÿ</label>
                    <input type="text" id="inputSymbol" placeholder="ä¾‹å¦‚: 2330, AAPL, TSLA" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none uppercase" required>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">å¸‚å ´</label>
                        <select id="inputMarket" onchange="updateCurrencyHint()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                            <option value="å°è‚¡">å°è‚¡ (TW)</option>
                            <option value="ç¾è‚¡">ç¾è‚¡ (US)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">æŒæœ‰è‚¡æ•¸</label>
                        <input type="number" id="inputShares" step="any" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" required>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">å¹³å‡æˆæœ¬ (å–®åƒ¹)</label>
                    <div class="relative">
                        <input type="number" id="inputCost" step="any" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" required>
                        <span id="currencyHint" class="absolute right-3 top-2 text-gray-400 text-sm">TWD</span>
                    </div>
                </div>
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl shadow-lg shadow-indigo-200 transition-all transform hover:-translate-y-0.5 mt-4">
                    å„²å­˜æŒè‚¡
                </button>
            </form>
        </div>
    </div>

    <!-- æ¨¡æ…‹æ¡†: æ‰‹å‹•åƒ¹æ ¼è¼¸å…¥ -->
    <div id="priceModal" class="fixed inset-0 bg-gray-900/50 hidden items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 m-4">
            <h3 class="text-lg font-bold text-gray-800 mb-2">æ‰‹å‹•ä¿®æ­£åƒ¹æ ¼</h3>
            <p id="priceModalSymbol" class="text-sm text-gray-500 mb-4">Target</p>
            <input type="number" id="manualPriceInput" step="any" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 outline-none text-lg font-medium mb-4" placeholder="è¼¸å…¥æœ€æ–°å¸‚åƒ¹">
            <div class="flex justify-end space-x-3">
                <button onclick="closePriceModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">å–æ¶ˆ</button>
                <button id="savePriceBtn" class="px-4 py-2 bg-pink-500 text-white rounded-lg hover:bg-pink-600 shadow-md">æ›´æ–°</button>
            </div>
        </div>
    </div>
    
    <!-- æ¨¡æ…‹æ¡†: åˆªé™¤ç¢ºèª (Custom Modal) -->
    <div id="deleteConfirmModal" class="fixed inset-0 bg-gray-900/50 hidden items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 m-4">
            <h3 class="text-lg font-bold text-gray-800 mb-2">ç¢ºèªåˆªé™¤</h3>
            <p id="deleteModalMessage" class="text-sm text-gray-500 mb-4">ç¢ºå®šè¦åˆªé™¤æ­¤æŒè‚¡ç´€éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚</p>
            <div class="flex justify-end space-x-3">
                <button onclick="closeDeleteConfirmModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">å–æ¶ˆ</button>
                <button id="confirmDeleteBtn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 shadow-md">ç¢ºå®šåˆªé™¤</button>
            </div>
        </div>
    </div>

    <!-- æ¨¡æ…‹æ¡†: Gemini LLM åˆ†æçµæœ -->
    <div id="analysisModal" class="fixed inset-0 bg-gray-900/50 hidden items-center justify-center z-50 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-6 transform transition-all scale-100 m-4">
            <div class="flex justify-between items-center mb-6 border-b pb-3">
                <h3 id="analysisModalTitle" class="text-xl font-bold text-gray-800">åˆ†æå ±å‘Š</h3>
                <button onclick="closeAnalysisModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            <div id="analysisModalContent" class="text-gray-700 leading-relaxed max-h-96 overflow-y-auto">
                <div class="flex justify-center items-center py-10">
                    <div class="w-6 h-6 border-4 border-indigo-400 border-t-transparent border-solid rounded-full animate-spin"></div>
                    <p class="ml-3 text-indigo-600">AI æ­£åœ¨åŠªåŠ›åˆ†æä¸­...</p>
                </div>
            </div>
             <div id="analysisModalSources" class="text-xs text-gray-500 mt-4 pt-4 border-t border-gray-100 hidden">
                <p class="font-semibold mb-1">åƒè€ƒè³‡è¨Šä¾†æº:</p>
                <ul id="sourceList" class="space-y-1 list-disc pl-5"></ul>
            </div>
            <div class="flex justify-end mt-6">
                <button onclick="closeAnalysisModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-xl shadow-lg transition-colors">é—œé–‰</button>
            </div>
        </div>
    </div>

    <!-- Toast è¨Šæ¯ -->
    <div id="toast" class="fixed top-5 right-5 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-xl transform translate-x-full transition-transform duration-300 z-50 flex items-center">
        <span id="toastMsg">Message</span>
    </div>

    <script>
        // ==========================================
        // æ ¸å¿ƒç‹€æ…‹èˆ‡æ•¸æ“š
        // ==========================================
        const APP_STATE = {
            exchangeRate: 32.5, // é è¨­åŒ¯ç‡ï¼Œå¯å˜—è©¦æŠ“å–æ›´æ–°
            prices: {}, // { "2330": { price: 1000, source: 'API'/'Manual' } }
            portfolio: [],
            chartInstance: null
        };

        // ==========================================
        // åˆå§‹åŒ–èˆ‡ç”Ÿå‘½é€±æœŸ
        // ==========================================
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            render();
            // å»¶é²è‡ªå‹•æ›´æ–°ä¸€æ¬¡æ•¸æ“š
            setTimeout(() => updateData(true), 1000);
        });

        function loadData() {
            const saved = localStorage.getItem('stockZen_portfolio');
            if (saved) {
                APP_STATE.portfolio = JSON.parse(saved);
            } else {
                // é è¨­ç¯„ä¾‹æ•¸æ“š
                APP_STATE.portfolio = [
                    { symbol: "2330", market: "å°è‚¡", shares: 1000, cost: 600 },
                    { symbol: "AAPL", market: "ç¾è‚¡", shares: 50, cost: 150 }
                ];
            }
            
            const savedPrices = localStorage.getItem('stockZen_prices');
            if (savedPrices) APP_STATE.prices = JSON.parse(savedPrices);
        }

        function saveData() {
            localStorage.setItem('stockZen_portfolio', JSON.stringify(APP_STATE.portfolio));
            localStorage.setItem('stockZen_prices', JSON.stringify(APP_STATE.prices));
        }

        // ==========================================
        // é€šç”¨ API èˆ‡ LLM å‘¼å«å·¥å…·
        // ==========================================

        async function fetchWithBackoff(url, options, maxRetries = 2) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429) {
                        await new Promise(r => setTimeout(r, 1000 * Math.pow(2, i)));
                        continue;
                    }
                    return await response.json();
                } catch (e) {
                    if (i === maxRetries - 1) throw e;
                }
            }
        }

        async function callGemini(prompt, isGrounded = false, systemInstruction = null) {
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
            };
            
            if (isGrounded) {
                payload.tools = [{ "google_search": {} }];
            }
            
            if (systemInstruction) {
                payload.systemInstruction = { parts: [{ text: systemInstruction }] };
            }

            try {
                const data = await fetchWithBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const candidate = data.candidates?.[0];
                
                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const text = candidate.content.parts[0].text;
                    let sources = [];

                    // Extract grounding sources if used
                    const groundingMetadata = candidate.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title);
                    }
                    return { text, sources };
                }
                return { text: "æœªèƒ½ç”Ÿæˆåˆ†æçµæœã€‚è«‹ç¨å¾Œå†è©¦ã€‚", sources: [] };

            } catch (e) {
                console.error("Gemini API Error:", e);
                return { text: "é€£ç·šéŒ¯èª¤ï¼Œç„¡æ³•å–å¾— AI åˆ†æã€‚", sources: [] };
            }
        }


        // ==========================================
        // æ•¸æ“šç²å– (Google Search Grounding - Price)
        // ==========================================
        async function updateData(silent = false) {
            if (!silent) showToast("æ­£åœ¨æœå°‹æœ€æ–°å ±åƒ¹...", "info");

            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const targets = APP_STATE.portfolio.filter(item => {
                const current = APP_STATE.prices[item.symbol];
                return !current || current.source !== 'Manual';
            });

            if (targets.length === 0 && !silent) {
                showToast("æ‰€æœ‰æ¨™çš„çš†ç‚ºæ‰‹å‹•é–å®šåƒ¹æ ¼", "info");
                render();
                return;
            }

            for (const item of targets) {
                const prompt = item.market === 'å°è‚¡' 
                    ? `Current stock price for Taiwan Stock ${item.symbol}. Return ONLY the numeric price in TWD.` 
                    : `Current stock price for US Stock ${item.symbol}. Return ONLY the numeric price in USD.`;

                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    tools: [{ "google_search": {} }],
                    systemInstruction: { parts: [{ text: "You are a price fetcher. Return only the latest raw number. No currency symbols." }] }
                };

                try {
                    const data = await fetchWithBackoff(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    // Robust extraction of floating point number
                    const priceMatch = text?.match(/[\d\.]+/);
                    const price = priceMatch ? parseFloat(priceMatch[0]) : NaN;

                    if (price && !isNaN(price) && price > 0) {
                        APP_STATE.prices[item.symbol] = { price: price, source: 'API' };
                    }
                } catch (e) {
                    console.error(`Error fetching ${item.symbol}`, e);
                }
                await new Promise(r => setTimeout(r, 500));
            }

            saveData();
            render();
            if (!silent) showToast("å ±åƒ¹æ›´æ–°å®Œæˆ", "success");
        }

        // ==========================================
        // æ¸²æŸ“é‚è¼¯
        // ==========================================
        function render() {
            const tbody = document.getElementById('holdingsList');
            tbody.innerHTML = '';
            
            let totalNetWorth = 0;
            let totalCost = 0;
            const allocationData = { labels: [], data: [], colors: [] };
            const bgColors = ['#6366f1', '#ec4899', '#10b981', '#f59e0b', '#3b82f6', '#8b5cf6'];

            if (APP_STATE.portfolio.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8" class="px-6 py-8 text-center text-gray-400">é»æ“Šå·¦å´ã€Œæ–°å¢æŒè‚¡ã€é–‹å§‹ç®¡ç†æ‚¨çš„è²¡å¯Œ</td></tr>`;
            }

            APP_STATE.portfolio.forEach((item, index) => {
                const priceData = APP_STATE.prices[item.symbol] || { price: 0, source: 'None' };
                const currentPrice = priceData.price;
                
                // è¨ˆç®— (çµ±ä¸€æ›ç®—æˆ TWD)
                let marketValueTWD = 0;
                let costTWD = 0;
                let profitTWD = 0;
                let profitPercent = 0;
                let displayPrice = currentPrice;
                let displayCost = item.cost;

                if (item.market === 'ç¾è‚¡') {
                    marketValueTWD = currentPrice * item.shares * APP_STATE.exchangeRate;
                    costTWD = item.cost * item.shares * APP_STATE.exchangeRate;
                    displayPrice = `US$ ${currentPrice.toFixed(2)}`;
                    displayCost = `US$ ${item.cost.toFixed(2)}`;
                } else {
                    marketValueTWD = currentPrice * item.shares;
                    costTWD = item.cost * item.shares;
                    displayPrice = `NT$ ${currentPrice.toFixed(2)}`;
                    displayCost = `NT$ ${item.cost.toFixed(2)}`;
                }

                if (costTWD > 0) { // Avoid division by zero
                    profitTWD = marketValueTWD - costTWD;
                    profitPercent = (profitTWD / costTWD) * 100;
                } else if (marketValueTWD > 0) {
                    profitTWD = marketValueTWD;
                    profitPercent = 100; // Infinite P&L is represented as 100% or simply ignored for safety
                }

                totalNetWorth += marketValueTWD;
                totalCost += costTWD;

                // Chart Data
                allocationData.labels.push(item.symbol);
                allocationData.data.push(marketValueTWD);
                allocationData.colors.push(bgColors[index % bgColors.length]);

                // Render Row
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50 transition-colors border-b border-gray-50 last:border-0";
                
                // ç´…æ¼²ç¶ è·Œæ¨£å¼
                const colorClass = profitTWD >= 0 ? 'text-red-500' : 'text-green-600';
                const sign = profitTWD >= 0 ? '+' : '';
                const sourceBadge = priceData.source === 'Manual' ? '<span class="text-[10px] bg-pink-100 text-pink-600 px-1 rounded ml-1">æ‰‹å‹•</span>' : '';

                tr.innerHTML = `
                    <td class="px-6 py-4 font-bold text-gray-800 flex items-center">
                        ${item.symbol} 
                        <span class="ml-2 text-xs font-normal text-gray-400 bg-gray-100 px-1.5 py-0.5 rounded">${item.market}</span>
                    </td>
                    <td class="px-6 py-4 text-right cursor-pointer hover:text-indigo-600 transition-colors" onclick="openPriceModal('${item.symbol}')">
                        <div class="font-medium">${displayPrice}</div>
                        <div class="text-xs text-gray-400 flex justify-end items-center">${sourceBadge}</div>
                    </td>
                    <td class="px-6 py-4 text-right text-gray-500">${displayCost}</td>
                    <td class="px-6 py-4 text-right text-gray-600">${item.shares.toLocaleString()}</td>
                    <td class="px-6 py-4 text-right font-medium text-gray-800">${Math.round(marketValueTWD).toLocaleString()}</td>
                    <td class="px-6 py-4 text-right ${colorClass} font-medium">${sign}${Math.round(profitTWD).toLocaleString()}</td>
                    <td class="px-6 py-4 text-right ${colorClass} font-medium">${sign}${profitPercent.toFixed(2)}%</td>
                    <td class="px-6 py-4 text-center space-x-2">
                        <!-- New LLM Feature 2: Stock Analysis -->
                        <button onclick="openStockAnalysisModal('${item.symbol}')" class="text-xs text-indigo-500 hover:text-indigo-700 transition-colors font-medium p-1">âœ¨ åˆ†æ</button>
                        <button onclick="openDeleteConfirmModal(${index})" class="text-gray-300 hover:text-red-500 transition-colors p-1">ğŸ—‘ï¸</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            // æ›´æ–°ç¸½è¦½å¡ç‰‡
            const totalPL = totalNetWorth - totalCost;
            const totalPLPercent = totalCost > 0 ? (totalPL / totalCost) * 100 : 0;
            const totalColor = totalPL >= 0 ? 'text-red-500' : 'text-green-600';
            const totalSign = totalPL >= 0 ? '+' : '';

            document.getElementById('totalNetWorth').innerText = `NT$ ${Math.round(totalNetWorth).toLocaleString()}`;
            document.getElementById('totalPL').innerText = `NT$ ${Math.round(totalPL).toLocaleString()}`;
            document.getElementById('totalPL').className = `text-3xl font-bold tracking-tight ${totalColor}`;
            
            const plBadge = document.getElementById('totalPLPercent');
            plBadge.innerText = `${totalSign}${totalPLPercent.toFixed(2)}%`;
            plBadge.className = `inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${totalPL >= 0 ? 'bg-red-50 text-red-600' : 'bg-green-50 text-green-600'}`;

            // ç¹ªè£½/æ›´æ–°åœ–è¡¨
            renderChart(allocationData);
        }

        function renderChart(data) {
            const ctx = document.getElementById('allocationChart').getContext('2d');
            
            if (APP_STATE.chartInstance) {
                APP_STATE.chartInstance.destroy();
            }

            if (data.data.length === 0) return;

            APP_STATE.chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.labels,
                    datasets: [{
                        data: data.data,
                        backgroundColor: data.colors,
                        borderWidth: 0,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: { position: 'bottom', labels: { boxWidth: 10, usePointStyle: true, font: { size: 10 } } },
                        tooltip: { 
                            callbacks: { 
                                label: (ctx) => ` ${ctx.label}: NT$${Math.round(ctx.raw).toLocaleString()}` 
                            } 
                        }
                    }
                }
            });
        }

        // ==========================================
        // äº’å‹•åŠŸèƒ½
        // ==========================================
        function openAddModal() {
            document.getElementById('addModal').classList.remove('hidden');
            document.getElementById('addModal').classList.add('flex');
            updateCurrencyHint();
        }

        function closeAddModal() {
            document.getElementById('addModal').classList.add('hidden');
            document.getElementById('addModal').classList.remove('flex');
            document.getElementById('assetForm').reset();
        }

        function updateCurrencyHint() {
            const market = document.getElementById('inputMarket').value;
            document.getElementById('currencyHint').innerText = market === 'å°è‚¡' ? 'TWD' : 'USD';
        }

        function handleAssetSubmit(e) {
            e.preventDefault();
            const symbol = document.getElementById('inputSymbol').value.toUpperCase();
            const market = document.getElementById('inputMarket').value;
            const shares = parseFloat(document.getElementById('inputShares').value);
            const cost = parseFloat(document.getElementById('inputCost').value);

            const newItem = { symbol, market, shares, cost };
            
            // ç°¡å–®æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨ï¼Œè‹¥å­˜åœ¨å‰‡è¦†è“‹ (ç°¡å–®é‚è¼¯)
            const idx = APP_STATE.portfolio.findIndex(i => i.symbol === symbol);
            if (idx >= 0) {
                APP_STATE.portfolio[idx] = newItem;
                showToast(`å·²æ›´æ–° ${symbol}`, "success");
            } else {
                APP_STATE.portfolio.push(newItem);
                showToast(`å·²æ–°å¢ ${symbol}`, "success");
            }

            saveData();
            render();
            closeAddModal();
            updateData(true); // å˜—è©¦æŠ“å–æ–°è‚¡ç¥¨åƒ¹æ ¼
        }
        
        // åˆªé™¤æŒè‚¡çš„åŸ·è¡Œå‡½æ•¸ (å–ä»£èˆŠçš„ deleteAsset)
        function executeDeleteAsset(index) {
            const removed = APP_STATE.portfolio.splice(index, 1);
            delete APP_STATE.prices[removed[0].symbol];
            saveData();
            render();
            showToast("å·²åˆªé™¤æŒè‚¡", "info");
            closeDeleteConfirmModal();
        }

        // åˆªé™¤æŒè‚¡çš„ç¢ºèªæ¨¡æ…‹æ¡†
        let assetIndexToDelete = null;

        function openDeleteConfirmModal(index) {
            assetIndexToDelete = index;
            const symbol = APP_STATE.portfolio[index].symbol;
            document.getElementById('deleteModalMessage').innerHTML = `ç¢ºå®šè¦åˆªé™¤ <span class="font-bold text-red-600">${symbol}</span> çš„æŒè‚¡ç´€éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`;
            
            document.getElementById('deleteConfirmModal').classList.remove('hidden');
            document.getElementById('deleteConfirmModal').classList.add('flex');

            document.getElementById('confirmDeleteBtn').onclick = () => {
                executeDeleteAsset(assetIndexToDelete);
            };
        }

        function closeDeleteConfirmModal() {
            document.getElementById('deleteConfirmModal').classList.add('hidden');
            document.getElementById('deleteConfirmModal').classList.remove('flex');
            assetIndexToDelete = null;
        }

        // æ‰‹å‹•åƒ¹æ ¼ä¿®æ­£
        let currentEditingSymbol = null;

        function openPriceModal(symbol) {
            currentEditingSymbol = symbol;
            document.getElementById('priceModalSymbol').innerText = `æ­£åœ¨ä¿®æ­£ ${symbol} çš„åƒ¹æ ¼`;
            const current = APP_STATE.prices[symbol]?.price || '';
            document.getElementById('manualPriceInput').value = current;
            
            document.getElementById('priceModal').classList.remove('hidden');
            document.getElementById('priceModal').classList.add('flex');
            
            // ç¶å®šæ›´æ–°æŒ‰éˆ•
            document.getElementById('savePriceBtn').onclick = () => {
                const newPrice = parseFloat(document.getElementById('manualPriceInput').value);
                if (newPrice > 0) {
                    APP_STATE.prices[currentEditingSymbol] = { price: newPrice, source: 'Manual' };
                    saveData();
                    render();
                    closePriceModal();
                    showToast("åƒ¹æ ¼å·²é–å®š", "success");
                }
            };
        }

        function closePriceModal() {
            document.getElementById('priceModal').classList.add('hidden');
            document.getElementById('priceModal').classList.remove('flex');
            currentEditingSymbol = null;
        }

        // Toast
        function showToast(msg, type = 'info') {
            const toast = document.getElementById('toast');
            toast.classList.remove('translate-x-full');
            
            const colors = { success: 'bg-green-600', info: 'bg-gray-800', error: 'bg-red-600' };
            toast.className = `fixed top-5 right-5 text-white px-6 py-3 rounded-lg shadow-xl transform transition-transform duration-300 z-50 flex items-center ${colors[type] || colors.info}`;
            document.getElementById('toastMsg').innerText = msg;

            setTimeout(() => {
                toast.classList.add('translate-x-full');
            }, 3000);
        }

        // ==========================================
        // Gemini LLM åˆ†æåŠŸèƒ½
        // ==========================================

        function openAnalysisModal(title, content, sources = []) {
            document.getElementById('analysisModalTitle').innerText = title;
            document.getElementById('analysisModalContent').innerHTML = content;
            
            const sourceContainer = document.getElementById('analysisModalSources');
            const sourceList = document.getElementById('sourceList');
            sourceList.innerHTML = '';

            if (sources.length > 0) {
                sourceContainer.classList.remove('hidden');
                sources.forEach(s => {
                    const li = document.createElement('li');
                    li.innerHTML = `<a href="${s.uri}" target="_blank" class="text-indigo-500 hover:underline">${s.title}</a>`;
                    sourceList.appendChild(li);
                });
            } else {
                 sourceContainer.classList.add('hidden');
            }

            document.getElementById('analysisModal').classList.remove('hidden');
            document.getElementById('analysisModal').classList.add('flex');
        }

        function closeAnalysisModal() {
            document.getElementById('analysisModal').classList.add('hidden');
            document.getElementById('analysisModal').classList.remove('flex');
        }

        // FEATURE 1: Portfolio Diversification Analysis
        async function analyzePortfolio() {
            openAnalysisModal("âœ¨ çµ„åˆå¤šå…ƒåŒ–åˆ†æ", `
                <div class="flex justify-center items-center py-10">
                    <div class="w-6 h-6 border-4 border-pink-400 border-t-transparent border-solid rounded-full animate-spin"></div>
                    <p class="ml-3 text-pink-600">AI æ­£åœ¨è©•ä¼°æ‚¨çš„æŠ•è³‡çµ„åˆçµæ§‹...</p>
                </div>
            `);

            if (APP_STATE.portfolio.length === 0) {
                openAnalysisModal("âœ¨ çµ„åˆå¤šå…ƒåŒ–åˆ†æ", "<p>è«‹å…ˆæ–°å¢æŒè‚¡ï¼ŒAI æ‰èƒ½ç‚ºæ‚¨åˆ†æçµ„åˆçµæ§‹ã€‚</p>");
                return;
            }

            // Prepare structured portfolio data for the LLM
            const structuredPortfolio = APP_STATE.portfolio.map(item => {
                const price = APP_STATE.prices[item.symbol]?.price || 0;
                const valueTWD = item.market === 'ç¾è‚¡' ? price * item.shares * APP_STATE.exchangeRate : price * item.shares;
                const costTWD = item.market === 'ç¾è‚¡' ? item.cost * item.shares * APP_STATE.exchangeRate : item.cost * item.shares;
                const plPercent = costTWD > 0 ? ((valueTWD - costTWD) / costTWD) * 100 : 0;

                return {
                    symbol: item.symbol,
                    market: item.market,
                    currentValueTWD: Math.round(valueTWD),
                    pLPercent: plPercent.toFixed(2) + "%"
                };
            });

            const portfolioPrompt = `
                åˆ†æä»¥ä¸‹æŠ•è³‡çµ„åˆæ•¸æ“šï¼ˆå·²æ›ç®—ç‚º TWDï¼‰ï¼š${JSON.stringify(structuredPortfolio, null, 2)}ã€‚
                è«‹å°ˆæ³¨æ–¼ã€Œå¸‚å ´é›†ä¸­åº¦ã€ï¼ˆç¾è‚¡ vs. å°è‚¡ï¼‰å’Œã€Œæç›Šç‹€æ…‹ã€ã€‚
                è«‹ç”¨ç¹é«”ä¸­æ–‡æä¾›ä¸€å€‹ä¸‰é»å¼çš„åˆ†æå ±å‘Šï¼š
                1. å ±å‘Šç›®å‰çš„é›†ä¸­åº¦é¢¨éšªã€‚
                2. æ ¹æ“šæ•¸æ“šï¼Œçµ¦å‡ºä¸€å€‹å…·é«”çš„å¤šå…ƒåŒ–å»ºè­°ï¼ˆä¾‹å¦‚ï¼Œåˆ†æ•£åˆ°å“ªå€‹å¸‚å ´/è³‡ç”¢é¡åˆ¥ï¼‰ã€‚
                3. ç¸½çµæŠ•è³‡çµ„åˆç•¶å‰çš„ç¸½é«”é¢¨éšªæˆ–æœ€å¤§äº®é»ã€‚
                è«‹ä½¿ç”¨ HTML æ®µè½ <p> å’Œåˆ—è¡¨ <ul>/<li> æ ¼å¼åŒ–æ‚¨çš„è¼¸å‡ºã€‚
            `;

            const systemInstruction = "ä½ æ˜¯ä¸€ä½è³‡æ·±è²¡å‹™åˆ†æå¸«ï¼Œå°ˆé–€ç‚ºå€‹äººæŠ•è³‡è€…æä¾›ç°¡æ½”ã€é‡é»æ˜ç¢ºçš„æŠ•è³‡çµ„åˆå»ºè­°ã€‚åªæ ¹æ“šæä¾›çš„æ•¸æ“šé€²è¡Œåˆ†æï¼Œä¸¦åš´æ ¼ä½¿ç”¨ç¹é«”ä¸­æ–‡ã€‚";

            const result = await callGemini(portfolioPrompt, false, systemInstruction);

            // LLM generates formatted HTML content based on the prompt
            openAnalysisModal("âœ¨ çµ„åˆå¤šå…ƒåŒ–åˆ†æ", result.text, result.sources);
        }

        // FEATURE 2: Single Stock Analysis (Grounded Search)
        async function openStockAnalysisModal(symbol) {
            openAnalysisModal(`âœ¨ ${symbol} è¿‘æœŸåˆ†æ`, `
                <div class="flex justify-center items-center py-10">
                    <div class="w-6 h-6 border-4 border-indigo-400 border-t-transparent border-solid rounded-full animate-spin"></div>
                    <p class="ml-3 text-indigo-600">AI æ­£åœ¨æœå°‹ ${symbol} çš„æœ€æ–°è³‡è¨Š...</p>
                </div>
            `);

            const item = APP_STATE.portfolio.find(i => i.symbol === symbol);
            if (!item) return;

            const marketText = item.market === 'å°è‚¡' ? 'å°ç£è‚¡å¸‚' : 'ç¾åœ‹è‚¡å¸‚';
            
            const stockPrompt = `
                Summarize the latest major news, recent performance, and analyst consensus (if available) for ${marketText} stock symbol ${symbol}. The response must be a single paragraph of about 4-5 sentences, written in Traditional Chinese.
            `;
            
            const systemInstruction = "ä½ æ˜¯ä¸€ä½é‡‘èæ–°èæ‘˜è¦å“¡ã€‚æ ¹æ“š Google æœå°‹çµæœï¼Œç‚ºæŒ‡å®šè‚¡ç¥¨æä¾›ä¸€å€‹å…¬æ­£ã€ç°¡æ½”çš„ç¹é«”ä¸­æ–‡åˆ†ææ®µè½ã€‚åš´ç¦åŠ å…¥å•å€™èªæˆ–çµèªã€‚";

            const result = await callGemini(stockPrompt, true, systemInstruction);

            // LLM returns raw text, wrap it in <p>
            const formattedText = `<p class="whitespace-pre-wrap">${result.text}</p>`;
            openAnalysisModal(`âœ¨ ${symbol} è¿‘æœŸåˆ†æ`, formattedText, result.sources);
        }

    </script>
</body>
</html>
