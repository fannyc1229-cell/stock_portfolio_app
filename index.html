<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StockZen | å€‹äººè³‡ç”¢ç®¡ç†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <!-- Firebase Imports for Database and Auth -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, where, updateDoc, getDoc, getDocs, deleteDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Expose Firebase services globally
        window.firebase = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
            getFirestore, doc, setDoc, onSnapshot, collection, query, where, updateDoc, getDoc, getDocs, deleteDoc, setLogLevel
        };
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3ff6; }
        
        /* è‡ªå®šç¾©æ»¾å‹•æ¢ */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }

        /* Chart Container */
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        /* éš±è—æ•¸å­—è¼¸å…¥æ¡†çš„ç®­é ­ */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* å‹•ç•« */
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
    <!-- æ‡‰ç”¨ç¨‹å¼çµæ§‹è¨ˆç•«: å„€è¡¨æ¿ä½ˆå±€ï¼Œæ ¸å¿ƒåŠŸèƒ½æ˜¯åˆ©ç”¨ Firestore å…±äº«å ±åƒ¹å’Œ LLM é€²è¡Œ AI åˆ†æã€‚ -->
</head>
<body class="text-gray-800 h-screen flex overflow-hidden">

    <!-- æ¡Œé¢å´é‚Šæ¬„ -->
    <aside class="hidden md:flex md:flex-col w-64 bg-slate-900 text-white transition-all duration-300 z-10">
        <div class="p-6 border-b border-slate-800 flex items-center justify-between">
            <h1 class="text-2xl font-bold tracking-tight">StockZen</h1>
            <span class="text-xs bg-slate-700 px-2 py-1 rounded text-slate-300">v2.3 (ç„¡APIå ±åƒ¹)</span>
        </div>
        <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
            <a href="#" class="flex items-center space-x-3 px-4 py-3 bg-slate-800 rounded-lg text-white shadow-sm">
                <span class="text-xl">ğŸ“Š</span>
                <span class="font-medium">å„€è¡¨æ¿</span>
            </a>
            <div class="mt-8 px-4 text-xs font-semibold text-slate-500 uppercase tracking-wider">è³‡ç”¢ç®¡ç†</div>
            <button onclick="openAddModal()" class="w-full mt-2 flex items-center space-x-3 px-4 py-3 text-slate-400 hover:bg-slate-800 hover:text-white rounded-lg transition-colors text-left">
                <span class="text-xl">â•</span>
                <span class="font-medium">æ–°å¢æŒè‚¡</span>
            </button>
             <button onclick="showManualUpdateTip()" class="w-full mt-1 flex items-center space-x-3 px-4 py-3 text-slate-400 hover:bg-slate-800 hover:text-white rounded-lg transition-colors text-left">
                <span class="text-xl">ğŸ’¡</span>
                <span class="font-medium">åƒ¹æ ¼æ›´æ–°æç¤º</span>
            </button>
        </nav>
        <div class="p-4 border-t border-slate-800">
            <div class="flex items-center space-x-3 px-4 py-2">
                <div class="w-8 h-8 rounded-full bg-indigo-500 flex items-center justify-center text-sm font-bold">U</div>
                <div>
                    <p class="text-sm font-medium">å€‹äººæŠ•è³‡çµ„åˆ</p>
                    <p class="text-xs text-slate-400" id="userIdDisplay">Loading...</p>
                </div>
            </div>
        </div>
    </aside>

    <!-- ä¸»å…§å®¹å€å¡Š -->
    <div class="flex-1 flex flex-col h-screen overflow-hidden relative">
        
        <!-- æ‰‹æ©Ÿç‰ˆé ‚éƒ¨å°èˆª -->
        <header class="md:hidden bg-slate-900 text-white p-4 flex justify-between items-center shadow-md z-20">
            <h1 class="text-xl font-bold">StockZen</h1>
            <button onclick="openAddModal()" class="text-2xl focus:outline-none">â•</button>
        </header>

        <!-- æ»¾å‹•å…§å®¹å€åŸŸ -->
        <main class="flex-1 overflow-y-auto p-4 md:p-8 relative">
            
            <!-- é ‚éƒ¨è³‡è¨Šå¡ç‰‡ -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 fade-in">
                <!-- ç¸½è³‡ç”¢ -->
                <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 flex flex-col justify-between relative overflow-hidden">
                    <div class="absolute right-0 top-0 p-4 opacity-5 text-6xl">ğŸ’°</div>
                    <div>
                        <p class="text-sm font-medium text-gray-500 mb-1">ç¸½è³‡ç”¢æ·¨å€¼ (TWD)</p>
                        <h2 id="totalNetWorth" class="text-3xl font-bold text-slate-900 tracking-tight">NT$ 0</h2>
                    </div>
                    <div class="mt-4 flex items-center text-sm">
                        <span class="text-gray-400">åŒ¯ç‡åƒè€ƒ: 1 USD â‰ˆ <span id="exchangeRateDisplay">32.5</span> TWD</span>
                    </div>
                </div>

                <!-- ç¸½æç›Š -->
                <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 flex flex-col justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-500 mb-1">æœªå¯¦ç¾ç¸½æç›Š</p>
                        <h2 id="totalPL" class="text-3xl font-bold text-gray-900 tracking-tight">NT$ 0</h2>
                    </div>
                    <div class="mt-4">
                        <span id="totalPLPercent" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                            0.00%
                        </span>
                    </div>
                </div>

                <!-- æŠ•è³‡åˆ†ä½ˆ (åœ“é¤…åœ–) -->
                <div class="bg-white rounded-xl shadow-sm p-4 border border-gray-100 md:row-span-2 flex flex-col items-center justify-center">
                     <h3 class="text-sm font-medium text-gray-500 w-full text-left mb-2">è³‡ç”¢é…ç½®</h3>
                     <div class="chart-container">
                        <canvas id="allocationChart"></canvas>
                     </div>
                </div>

                <!-- å¸‚å ´ç‹€æ…‹ / å¿«é€Ÿæ“ä½œ (ä½”æ“šå‰©é¤˜ç©ºé–“) -->
                <div class="bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl shadow-lg p-6 text-white md:col-span-2">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-lg font-bold mb-2">å¸‚å ´å¿«è¨Š (æ‰‹å‹•æ¨¡å¼)</h3>
                            <p class="text-indigo-100 text-sm mb-4">é»æ“Šåƒ¹æ ¼å¯æ‰‹å‹•è¼¸å…¥æœ€æ–°å ±åƒ¹ï¼Œä¸¦**å³æ™‚å…±äº«**çµ¦æ‰€æœ‰ç”¨æˆ¶ã€‚</p>
                            <p class="text-xs text-indigo-200 opacity-80">* æœ¬æ‡‰ç”¨ç¨‹å¼å·²ç§»é™¤è‡ªå‹•å ±åƒ¹åŠŸèƒ½ï¼Œä»¥ä¿è­·æ‚¨çš„ API Keyã€‚</p>
                        </div>
                        <div class="flex flex-col space-y-2">
                            <button onclick="showManualUpdateTip()" class="bg-white text-indigo-600 hover:bg-indigo-50 px-4 py-2 rounded-lg text-sm font-bold shadow-sm transition-colors">
                                åƒ¹æ ¼æ›´æ–°æç¤º
                            </button>
                            <!-- New LLM Feature 1: Portfolio Analysis -->
                            <button onclick="analyzePortfolio()" class="bg-pink-500 text-white hover:bg-pink-600 px-4 py-2 rounded-lg text-sm font-bold shadow-sm transition-colors flex items-center justify-center space-x-1">
                                âœ¨ çµ„åˆåˆ†æ
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æŒè‚¡åˆ—è¡¨ -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden fade-in" style="animation-delay: 0.1s;">
                <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                    <h3 class="text-lg font-bold text-gray-800">æŒè‚¡æ˜ç´°</h3>
                    <span class="text-xs text-gray-400">é»æ“Šåƒ¹æ ¼å¯æ‰‹å‹•ä¿®æ­£ / é»æ“ŠæŒ‰éˆ•åœ¨å½ˆå‡ºè¦–çª—æŸ¥åƒ¹</span>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs text-gray-500 uppercase bg-gray-50/50">
                            <tr>
                                <th class="px-6 py-4 font-medium">æ¨™çš„</th>
                                <th class="px-6 py-4 font-medium text-right">ç¾åƒ¹</th>
                                <th class="px-6 py-4 font-medium text-right">å‡åƒ¹(æˆæœ¬)</th>
                                <th class="px-6 py-4 font-medium text-right">è‚¡æ•¸</th>
                                <th class="px-6 py-4 font-medium text-right">å¸‚å€¼ (TWD)</th>
                                <th class="px-6 py-4 font-medium text-right">æç›Š (TWD)</th>
                                <th class="px-6 py-4 font-medium text-right">æç›Š %</th>
                                <th class="px-6 py-4 font-medium text-center">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="holdingsList" class="divide-y divide-gray-100">
                            <!-- JS å°‡å¡«å……æ­¤è™• -->
                            <tr>
                                <td colspan="8" class="px-6 py-8 text-center text-gray-400">
                                    è¼‰å…¥ä¸­æˆ–å°šç„¡æŒè‚¡...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="h-20"></div> <!-- åº•éƒ¨ç•™ç™½ -->
        </main>
    </div>

    <!-- æ¨¡æ…‹æ¡†: Google æŸ¥åƒ¹ (æ–°å¢ iFrame è¦–çª—) -->
    <div id="searchModal" class="fixed inset-0 bg-gray-900/50 hidden items-center justify-center z-50 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl h-5/6 p-6 transform transition-all scale-100 m-4 flex flex-col">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h3 id="searchModalTitle" class="text-xl font-bold text-gray-800">æŸ¥è©¢æœ€æ–°å ±åƒ¹</h3>
                <button onclick="closeSearchModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            <p class="text-sm text-gray-500 mb-3">è«‹åœ¨ä¸‹æ–¹è¦–çª—æŸ¥çœ‹ Google æœå°‹çµæœä¸­çš„æœ€æ–°åƒ¹æ ¼ï¼Œç„¶å¾Œæ‰‹å‹•è¼¸å…¥ã€‚</p>
            <!-- iFrame ç”¨æ–¼åµŒå…¥ Google æœå°‹é é¢ -->
            <iframe id="googleSearchIframe" class="flex-1 w-full border border-gray-200 rounded-lg" src="about:blank"></iframe>
            <div class="flex justify-end mt-4">
                 <button onclick="closeSearchModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-xl shadow-lg transition-colors">å®Œæˆä¸¦é—œé–‰</button>
            </div>
        </div>
    </div>

    <!-- æ¨¡æ…‹æ¡†: æ–°å¢æŒè‚¡ -->
    <div id="addModal" class="fixed inset-0 bg-gray-900/50 hidden items-center justify-center z-50 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 transform transition-all scale-100 m-4">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800">æ–°å¢/ç·¨è¼¯ æŒè‚¡</h3>
                <button onclick="closeAddModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            <form id="assetForm" onsubmit="handleAssetSubmit(event)" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">è‚¡ç¥¨ä»£è™Ÿ</label>
                    <input type="text" id="inputSymbol" placeholder="ä¾‹å¦‚: 2330, AAPL, TSLA" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none uppercase" required>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">å¸‚å ´</label>
                        <select id="inputMarket" onchange="updateCurrencyHint()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                            <option value="å°è‚¡">å°è‚¡ (TW)</option>
                            <option value="ç¾è‚¡">ç¾è‚¡ (US)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">æŒæœ‰è‚¡æ•¸</label>
                        <input type="number" id="inputShares" step="any" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" required>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">å¹³å‡æˆæœ¬ (å–®åƒ¹)</label>
                    <div class="relative">
                        <input type="number" id="inputCost" step="any" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" required>
                        <span id="currencyHint" class="absolute right-3 top-2 text-gray-400 text-sm">TWD</span>
                    </div>
                </div>
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl shadow-lg shadow-indigo-200 transition-all transform hover:-translate-y-0.5 mt-4">
                    å„²å­˜æŒè‚¡
                </button>
            </form>
        </div>
    </div>

    <!-- æ¨¡æ…‹æ¡†: æ‰‹å‹•åƒ¹æ ¼è¼¸å…¥ -->
    <div id="priceModal" class="fixed inset-0 bg-gray-900/50 hidden items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 m-4">
            <h3 class="text-lg font-bold text-gray-800 mb-2">æ‰‹å‹•ä¿®æ­£åƒ¹æ ¼</h3>
            <p id="priceModalSymbol" class="text-sm text-gray-500 mb-4">Target</p>
            <input type="number" id="manualPriceInput" step="any" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 outline-none text-lg font-medium mb-4" placeholder="è¼¸å…¥æœ€æ–°å¸‚åƒ¹">
            <div class="flex justify-end space-x-3">
                <button onclick="closePriceModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">å–æ¶ˆ</button>
                <button id="savePriceBtn" class="px-4 py-2 bg-pink-500 text-white rounded-lg hover:bg-pink-600 shadow-md">æ›´æ–° (å…±äº«)</button>
            </div>
        </div>
    </div>
    
    <!-- æ¨¡æ…‹æ¡†: åˆªé™¤ç¢ºèª (Custom Modal) -->
    <div id="deleteConfirmModal" class="fixed inset-0 bg-gray-900/50 hidden items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 m-4">
            <h3 class="text-lg font-bold text-gray-800 mb-2">ç¢ºèªåˆªé™¤</h3>
            <p id="deleteModalMessage" class="text-sm text-gray-500 mb-4">ç¢ºå®šè¦åˆªé™¤æ­¤æŒè‚¡ç´€éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚</p>
            <div class="flex justify-end space-x-3">
                <button onclick="closeDeleteConfirmModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">å–æ¶ˆ</button>
                <button id="confirmDeleteBtn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 shadow-md">ç¢ºå®šåˆªé™¤</button>
            </div>
        </div>
    </div>

    <!-- æ¨¡æ…‹æ¡†: Gemini LLM åˆ†æçµæœ -->
    <div id="analysisModal" class="fixed inset-0 bg-gray-900/50 hidden items-center justify-center z-50 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-6 transform transition-all scale-100 m-4">
            <div class="flex justify-between items-center mb-6 border-b pb-3">
                <h3 id="analysisModalTitle" class="text-xl font-bold text-gray-800">åˆ†æå ±å‘Š</h3>
                <button onclick="closeAnalysisModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            <div id="analysisModalContent" class="text-gray-700 leading-relaxed max-h-96 overflow-y-auto">
                <div class="flex justify-center items-center py-10">
                    <div class="w-6 h-6 border-4 border-indigo-400 border-t-transparent border-solid rounded-full animate-spin"></div>
                    <p class="ml-3 text-indigo-600">AI æ­£åœ¨åŠªåŠ›åˆ†æä¸­...</p>
                </div>
            </div>
             <div id="analysisModalSources" class="text-xs text-gray-500 mt-4 pt-4 border-t border-gray-100 hidden">
                <p class="font-semibold mb-1">åƒè€ƒè³‡è¨Šä¾†æº:</p>
                <ul id="sourceList" class="space-y-1 list-disc pl-5"></ul>
            </div>
            <div class="flex justify-end mt-6">
                <button onclick="closeAnalysisModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-xl shadow-lg transition-colors">é—œé–‰</button>
            </div>
        </div>
    </div>

    <!-- Toast è¨Šæ¯ -->
    <div id="toast" class="fixed top-5 right-5 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-xl transform translate-x-full transition-transform duration-300 z-50 flex items-center">
        <span id="toastMsg">Message</span>
    </div>

    <script>
        // ==========================================
        // æ ¸å¿ƒç‹€æ…‹èˆ‡æ•¸æ“š
        // ==========================================
        
        // ğŸš¨ğŸš¨ğŸš¨ é‡è¦ï¼šå ±åƒ¹åŠŸèƒ½è­¦å‘Š ğŸš¨ğŸš¨ğŸš¨
        // ç‚ºé¿å… API Key æ´©éœ²èˆ‡ç”¢ç”Ÿè²»ç”¨ï¼Œè‡ªå‹•å ±åƒ¹åŠŸèƒ½å·²ç§»é™¤ã€‚
        // API Key åƒ…ç”¨æ–¼ AI åˆ†æåŠŸèƒ½ (çµ„åˆåˆ†æã€å€‹è‚¡åˆ†æ)ã€‚
        const API_KEY = "";
        const BASE_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=";

        const APP_STATE = {
            exchangeRate: 32.5, // é è¨­åŒ¯ç‡
            prices: {}, // { "2330": { price: 1000, source: 'API'/'Manual' } }
            portfolio: [],
            chartInstance: null,
            isAuthReady: false,
            userId: null
        };
        
        // --- Firebase Globals ---
        let db, auth;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-stockzen-app';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // å…¬å…±å ±åƒ¹çš„ Firestore è·¯å¾‘ (å…±äº«å ±åƒ¹çš„é—œéµ)
        const PUBLIC_PRICES_PATH = `artifacts/${appId}/public/data/stock_prices`;
        
        // ==========================================
        // åˆå§‹åŒ–èˆ‡ç”Ÿå‘½é€±æœŸ (ä½¿ç”¨ Firestore)
        // ==========================================
        document.addEventListener('DOMContentLoaded', () => {
            if (firebaseConfig) {
                initFirebase();
            } else {
                console.error("Firebase configuration is missing. Running in local storage mode.");
                loadDataFromLocalStorage();
                render();
            }
        });

        // å¾ Local Storage è¼‰å…¥åˆå§‹/ç¯„ä¾‹æ•¸æ“š (ç”¨æ–¼ç¬¬ä¸€æ¬¡ä½¿ç”¨æˆ– Firebase å¤±æ•—æ™‚çš„å¾Œå‚™)
        function loadDataFromLocalStorage() {
            const saved = localStorage.getItem('stockZen_portfolio');
            if (saved) {
                APP_STATE.portfolio = JSON.parse(saved);
            } else {
                // é è¨­ç¯„ä¾‹æ•¸æ“š
                APP_STATE.portfolio = [
                    { symbol: "2330", market: "å°è‚¡", shares: 1000, cost: 600 },
                    { symbol: "AAPL", market: "ç¾è‚¡", shares: 50, cost: 150 }
                ];
            }
            const savedPrices = localStorage.getItem('stockZen_prices');
            if (savedPrices) APP_STATE.prices = JSON.parse(savedPrices);
        }

        async function initFirebase() {
            const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore } = window.firebase;
            
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // 1. Authenticate
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken).catch(e => {
                    console.error("Custom token sign in failed, signing anonymously.", e);
                    return signInAnonymously(auth);
                });
            } else {
                await signInAnonymously(auth);
            }
            
            // 2. Set up Auth Listener and Data Subscription
            onAuthStateChanged(auth, (user) => {
                APP_STATE.userId = user ? user.uid : crypto.randomUUID();
                APP_STATE.isAuthReady = true;
                
                // é¡¯ç¤º userId
                const userDisplayEl = document.getElementById('userIdDisplay');
                if(userDisplayEl) userDisplayEl.innerText = `ID: ${APP_STATE.userId.substring(0, 8)}...`;

                subscribeToData();
                showToast("Firebase é€£ç·šæˆåŠŸï¼Œè¼‰å…¥æ‚¨çš„æŠ•è³‡çµ„åˆã€‚", "success");
            });
        }

        function subscribeToData() {
            if (!db || !APP_STATE.isAuthReady) return;
            
            const { onSnapshot, doc } = window.firebase;
            
            // --- è¨‚é–± ç§äººæŠ•è³‡çµ„åˆ ---
            const portfolioDocRef = doc(db, `artifacts/${appId}/users/${APP_STATE.userId}/portfolio/myPortfolio`);
            onSnapshot(portfolioDocRef, (docSnapshot) => {
                if (docSnapshot.exists() && docSnapshot.data().holdings) {
                    APP_STATE.portfolio = docSnapshot.data().holdings;
                } else {
                    // å¦‚æœç”¨æˆ¶æ˜¯ç¬¬ä¸€æ¬¡ä½¿ç”¨ï¼Œä½¿ç”¨ç¯„ä¾‹æ•¸æ“šä¸¦å„²å­˜
                    if (APP_STATE.portfolio.length === 0) {
                         loadDataFromLocalStorage(); // ä½¿ç”¨æœ¬åœ°ç¯„ä¾‹æ•¸æ“šä½œç‚ºåˆå§‹å€¼
                         savePortfolioToFirestore();
                    }
                }
                render();
            }, (error) => {
                console.error("Error subscribing to portfolio:", error);
                render(); 
            });
            
            // --- è¨‚é–± å…¬å…±å ±åƒ¹ (å¤šäººå…±äº«çš„é—œéµ) ---
            const pricesDocRef = doc(db, PUBLIC_PRICES_PATH, 'current');
            onSnapshot(pricesDocRef, (docSnapshot) => {
                if (docSnapshot.exists()) {
                    // Prices object structure: { "2330": { price: 1000, source: 'API'/'Manual' } }
                    APP_STATE.prices = docSnapshot.data() || {};
                } else {
                    APP_STATE.prices = {};
                }
                render();
            }, (error) => {
                console.error("Error subscribing to prices:", error);
                render(); 
            });
        }
        
        async function savePortfolioToFirestore() {
            if (!db || !APP_STATE.isAuthReady || APP_STATE.portfolio.length === 0) return;
            const { doc, setDoc } = window.firebase;
            
            const portfolioDocRef = doc(db, `artifacts/${appId}/users/${APP_STATE.userId}/portfolio/myPortfolio`);
            try {
                // å°‡æ•´å€‹æŠ•è³‡çµ„åˆä½œç‚ºä¸€å€‹æ–‡ä»¶å„²å­˜
                await setDoc(portfolioDocRef, { holdings: APP_STATE.portfolio }, { merge: false });
            } catch (e) {
                console.error("Error saving portfolio to Firestore:", e);
                showToast("å„²å­˜æŠ•è³‡çµ„åˆå¤±æ•—ã€‚", "error");
            }
        }
        
        /**
         * ğŸš¨ å ±åƒ¹åŠŸèƒ½å·²ç§»é™¤ ğŸš¨
         * æ­¤å‡½æ•¸ç¾åœ¨åƒ…ç”¨æ–¼æç¤ºç”¨æˆ¶æ‡‰æ‰‹å‹•è¼¸å…¥åƒ¹æ ¼ã€‚
         */
        function showManualUpdateTip() {
            showToast("å·²ç§»é™¤è‡ªå‹•å ±åƒ¹åŠŸèƒ½ã€‚è«‹é»æ“ŠæŒè‚¡åˆ—è¡¨ä¸­çš„åƒ¹æ ¼ï¼Œæ‰‹å‹•è¼¸å…¥æœ€æ–°å ±åƒ¹ã€‚è©²åƒ¹æ ¼æœƒè‡ªå‹•å…±äº«çµ¦æ‰€æœ‰ç”¨æˆ¶ã€‚", "info", 6000); 
        }


        // ==========================================
        // é€šç”¨ API èˆ‡ LLM å‘¼å«å·¥å…· (åƒ…ç”¨æ–¼ AI åˆ†æ)
        // ==========================================

        /**
         * å¸¶æœ‰æŒ‡æ•¸é€€é¿æ©Ÿåˆ¶çš„ Fetch å‡½æ•¸
         */
        async function fetchWithBackoff(url, options, maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429) { // é »ç‡é™åˆ¶
                        await new Promise(r => setTimeout(r, 1000 * Math.pow(2, i)));
                        continue;
                    }
                    if (!response.ok) {
                        throw new Error(`API response status: ${response.status} ${response.statusText}`);
                    }
                    return await response.json();
                } catch (e) {
                    if (i === maxRetries - 1) throw e;
                    await new Promise(r => setTimeout(r, 1000 * Math.pow(2, i)));
                }
            }
        }

        /**
         * å‘¼å« Gemini API é€²è¡Œæ–‡æœ¬ç”Ÿæˆæˆ–æ•¸æ“šæŸ¥è©¢ (ç”¨æ–¼ AI åˆ†æ)
         */
        async function callGemini(prompt, isGrounded = false, systemInstruction = null) {
            const apiUrl = `${BASE_API_URL}${API_KEY}`;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
            };
            
            if (isGrounded) {
                payload.tools = [{ "google_search": {} }];
            }
            
            if (systemInstruction) {
                payload.systemInstruction = { parts: [{ text: systemInstruction }] };
            }

            try {
                const data = await fetchWithBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const candidate = data.candidates?.[0];
                
                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const text = candidate.content.parts[0].text;
                    let sources = [];

                    // Extract grounding sources if used
                    const groundingMetadata = candidate.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title);
                    }
                    return { text, sources };
                }
                return { text: "æœªèƒ½ç”Ÿæˆåˆ†æçµæœã€‚è«‹ç¨å¾Œå†è©¦ã€‚", sources: [] };

            } catch (e) {
                console.error("Gemini API Error:", e);
                // æª¢æŸ¥æ˜¯å¦å› ç‚º API Key ç¼ºå¤±è€Œå¤±æ•—
                if (API_KEY === "") {
                     return { text: "API é‡‘é‘°ç¼ºå¤±ï¼šAI åˆ†æéœ€è¦ Gemini API Keyï¼Œè«‹æª¢æŸ¥ç¨‹å¼ç¢¼é ‚éƒ¨ã€‚", sources: [] };
                }
                return { text: "é€£ç·šéŒ¯èª¤ï¼Œç„¡æ³•å–å¾— AI åˆ†æã€‚", sources: [] };
            }
        }


        // ==========================================
        // æ¸²æŸ“é‚è¼¯
        // ==========================================
        function render() {
            const tbody = document.getElementById('holdingsList');
            tbody.innerHTML = '';
            
            let totalNetWorth = 0;
            let totalCost = 0;
            const allocationData = { labels: [], data: [], colors: [] };
            const bgColors = ['#6366f1', '#ec4899', '#10b981', '#f59e0b', '#3b82f6', '#8b5cf6'];

            if (APP_STATE.portfolio.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8" class="px-6 py-8 text-center text-gray-400">é»æ“Šå·¦å´ã€Œæ–°å¢æŒè‚¡ã€é–‹å§‹ç®¡ç†æ‚¨çš„è²¡å¯Œ</td></tr>`;
            }

            APP_STATE.portfolio.forEach((item, index) => {
                // å ±åƒ¹æ•¸æ“šä¾†è‡ªå…±äº«çš„ APP_STATE.prices (ç”±æ‰‹å‹•è¼¸å…¥è§¸ç™¼)
                const priceData = APP_STATE.prices[item.symbol] || { price: 0, source: 'None' };
                const currentPrice = priceData.price;
                
                // è¨ˆç®— (çµ±ä¸€æ›ç®—æˆ TWD)
                let marketValueTWD = 0;
                let costTWD = 0;
                let profitTWD = 0;
                let profitPercent = 0;
                let displayPrice = currentPrice;
                let displayCost = item.cost;

                if (item.market === 'ç¾è‚¡') {
                    marketValueTWD = currentPrice * item.shares * APP_STATE.exchangeRate;
                    costTWD = item.cost * item.shares * APP_STATE.exchangeRate;
                    displayPrice = currentPrice === 0 ? 'N/A' : `US$ ${currentPrice.toFixed(2)}`;
                    displayCost = `US$ ${item.cost.toFixed(2)}`;
                } else {
                    marketValueTWD = currentPrice * item.shares;
                    costTWD = item.cost * item.shares;
                    displayPrice = currentPrice === 0 ? 'N/A' : `NT$ ${currentPrice.toFixed(2)}`;
                    displayCost = `NT$ ${item.cost.toFixed(2)}`;
                }

                if (costTWD > 0) { // Avoid division by zero
                    profitTWD = marketValueTWD - costTWD;
                    profitPercent = (profitTWD / costTWD) * 100;
                } else if (marketValueTWD > 0) {
                    profitTWD = marketValueTWD;
                    profitPercent = 100; 
                }

                totalNetWorth += marketValueTWD;
                totalCost += costTWD;

                // Chart Data
                allocationData.labels.push(item.symbol);
                allocationData.data.push(marketValueTWD);
                allocationData.colors.push(bgColors[index % bgColors.length]);

                // Render Row
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50 transition-colors border-b border-gray-50 last:border-0";
                
                // ç´…æ¼²ç¶ è·Œæ¨£å¼
                const colorClass = profitTWD >= 0 ? 'text-red-500' : 'text-green-600';
                const sign = profitTWD >= 0 ? '+' : '';
                
                // é¡¯ç¤ºåƒ¹æ ¼ä¾†æº
                let sourceBadge = '';
                if (priceData.source === 'Manual') {
                    sourceBadge = '<span class="text-[10px] bg-pink-100 text-pink-600 px-1 rounded ml-1">æ‰‹å‹•/å…±äº«</span>';
                } else if (priceData.source === 'API') {
                    // ä»¥å‰çš„ API åƒ¹æ ¼æ¨™è¨˜ç‚ºèˆŠçš„å…±äº«åƒ¹æ ¼
                    sourceBadge = '<span class="text-[10px] bg-gray-100 text-gray-600 px-1 rounded ml-1">èˆŠå…±äº«åƒ¹</span>';
                } else {
                     sourceBadge = '<span class="text-[10px] bg-red-100 text-red-600 px-1 rounded ml-1">N/A</span>';
                }

                tr.innerHTML = `
                    <td class="px-6 py-4 font-bold text-gray-800 flex items-center">
                        ${item.symbol} 
                        <span class="ml-2 text-xs font-normal text-gray-400 bg-gray-100 px-1.5 py-0.5 rounded">${item.market}</span>
                    </td>
                    <td class="px-6 py-4 text-right cursor-pointer hover:text-indigo-600 transition-colors" onclick="openPriceModal('${item.symbol}')">
                        <div class="font-medium">${displayPrice}</div>
                        <div class="text-xs text-gray-400 flex justify-end items-center">${sourceBadge}</div>
                    </td>
                    <td class="px-6 py-4 text-right text-gray-500">${displayCost}</td>
                    <td class="px-6 py-4 text-right text-gray-600">${item.shares.toLocaleString()}</td>
                    <td class="px-6 py-4 text-right font-medium text-gray-800">${Math.round(marketValueTWD).toLocaleString()}</td>
                    <td class="px-6 py-4 text-right ${colorClass} font-medium">${sign}${Math.round(profitTWD).toLocaleString()}</td>
                    <td class="px-6 py-4 text-right ${colorClass} font-medium">${sign}${profitPercent.toFixed(2)}%</td>
                    <td class="px-6 py-4 text-center space-x-2">
                         <button onclick="openGoogleSearch('${item.symbol}')" class="text-xs text-blue-500 hover:text-blue-700 font-semibold px-2 py-1 rounded-lg bg-blue-50 transition-colors">Google æŸ¥åƒ¹</button>
                        <!-- New LLM Feature 2: Stock Analysis -->
                        <button onclick="openStockAnalysisModal('${item.symbol}')" class="text-xs text-indigo-500 hover:text-indigo-700 font-semibold px-2 py-1 rounded-lg bg-indigo-50 transition-colors">AI åˆ†æ</button>
                        <button onclick="deleteAsset('${item.symbol}')" class="text-xs text-red-500 hover:text-red-700 font-semibold px-2 py-1 rounded-lg bg-red-50 transition-colors">åˆªé™¤</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            // æ›´æ–°å„€è¡¨æ¿æ•¸æ“š
            document.getElementById('totalNetWorth').innerText = `NT$ ${Math.round(totalNetWorth).toLocaleString()}`;
            
            const totalPL = totalNetWorth - totalCost;
            const totalPLPercent = totalCost > 0 ? (totalPL / totalCost) * 100 : (totalPL > 0 ? 100 : 0);
            
            const totalPL_el = document.getElementById('totalPL');
            const totalPLPercent_el = document.getElementById('totalPLPercent');

            totalPL_el.innerText = `NT$ ${totalPL >= 0 ? '+' : ''}${Math.round(totalPL).toLocaleString()}`;
            totalPL_el.classList.toggle('text-red-600', totalPL > 0);
            totalPL_el.classList.toggle('text-green-600', totalPL < 0);
            totalPL_el.classList.toggle('text-gray-900', totalPL === 0);

            totalPLPercent_el.innerText = `${totalPLPercent >= 0 ? '+' : ''}${totalPLPercent.toFixed(2)}%`;
            totalPLPercent_el.classList.remove('bg-gray-100', 'bg-red-100', 'bg-green-100');
            totalPLPercent_el.classList.remove('text-gray-800', 'text-red-600', 'text-green-600');

            if (totalPL > 0) {
                totalPLPercent_el.classList.add('bg-red-100', 'text-red-600');
            } else if (totalPL < 0) {
                totalPLPercent_el.classList.add('bg-green-100', 'text-green-600');
            } else {
                totalPLPercent_el.classList.add('bg-gray-100', 'text-gray-800');
            }

            // æ›´æ–°åœ“é¤…åœ–
            updateChart(allocationData);
        }
        
        function updateChart(data) {
            const ctx = document.getElementById('allocationChart').getContext('2d');
            
            if (APP_STATE.chartInstance) {
                APP_STATE.chartInstance.destroy();
            }

            if (data.data.every(d => d === 0)) {
                // å¦‚æœæ‰€æœ‰å¸‚å€¼éƒ½æ˜¯ 0ï¼Œé¡¯ç¤ºä¸€å€‹ä»£è¡¨ç„¡æ•¸æ“šçš„åœ“é¤…
                data = {
                    labels: ['å°šç„¡æœ‰æ•ˆå¸‚å€¼'],
                    data: [1],
                    colors: ['#e5e7eb'] // Light gray
                };
            }

            APP_STATE.chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.labels,
                    datasets: [{
                        data: data.data,
                        backgroundColor: data.colors,
                        hoverOffset: 8,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                boxWidth: 12,
                                font: {
                                    family: 'Inter',
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        label += `NT$ ${Math.round(context.parsed).toLocaleString()}`;
                                    }
                                    return label;
                                }
                            },
                            bodyFont: { family: 'Inter' }
                        }
                    }
                }
            });
        }
        
        // ==========================================
        // äº’å‹•èˆ‡æ“ä½œ
        // ==========================================
        
        // --- å½ˆå‡ºå±¤/æ¨¡æ…‹æ¡†æ§åˆ¶ ---
        function openAddModal(symbol = null) {
            const modal = document.getElementById('addModal');
            const form = document.getElementById('assetForm');
            modal.classList.remove('hidden');
            modal.classList.add('flex', 'fade-in');
            
            form.reset();
            if (symbol) {
                const item = APP_STATE.portfolio.find(p => p.symbol === symbol);
                if (item) {
                    document.getElementById('inputSymbol').value = item.symbol;
                    document.getElementById('inputMarket').value = item.market;
                    document.getElementById('inputShares').value = item.shares;
                    document.getElementById('inputCost').value = item.cost;
                    updateCurrencyHint();
                    document.getElementById('inputSymbol').disabled = true; // ç·¨è¼¯æ™‚ä¸å¯æ”¹ä»£è™Ÿ
                }
            } else {
                document.getElementById('inputSymbol').disabled = false;
            }
        }

        function closeAddModal() {
            const modal = document.getElementById('addModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex', 'fade-in');
        }

        function updateCurrencyHint() {
            const market = document.getElementById('inputMarket').value;
            document.getElementById('currencyHint').innerText = market === 'å°è‚¡' ? 'TWD' : 'USD';
        }

        function openPriceModal(symbol) {
            const item = APP_STATE.portfolio.find(p => p.symbol === symbol);
            if (!item) return;

            const priceModal = document.getElementById('priceModal');
            document.getElementById('priceModalSymbol').innerText = `ç‚º ${item.symbol} (${item.market}) è¨­å®šæ‰‹å‹•åƒ¹æ ¼ï¼š`;
            
            const currentPrice = APP_STATE.prices[symbol]?.price || 0;
            document.getElementById('manualPriceInput').value = currentPrice > 0 ? currentPrice : '';

            const saveBtn = document.getElementById('savePriceBtn');
            saveBtn.onclick = () => saveManualPrice(symbol);
            
            priceModal.classList.remove('hidden');
            priceModal.classList.add('flex');
            document.getElementById('manualPriceInput').focus();
        }

        function closePriceModal() {
            document.getElementById('priceModal').classList.add('hidden');
            document.getElementById('priceModal').classList.remove('flex');
        }

        function openDeleteConfirmModal(symbol) {
            const modal = document.getElementById('deleteConfirmModal');
            document.getElementById('deleteModalMessage').innerText = `ç¢ºå®šè¦åˆªé™¤ä»£è™Ÿ ${symbol} çš„æŒè‚¡ç´€éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`;
            const confirmBtn = document.getElementById('confirmDeleteBtn');
            confirmBtn.onclick = () => confirmDelete(symbol);
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeDeleteConfirmModal() {
            document.getElementById('deleteConfirmModal').classList.add('hidden');
            document.getElementById('deleteConfirmModal').classList.remove('flex');
        }

        function openAnalysisModal(title) {
            const modal = document.getElementById('analysisModal');
            document.getElementById('analysisModalTitle').innerText = title;
            document.getElementById('analysisModalContent').innerHTML = `
                <div class="flex justify-center items-center py-10">
                    <div class="w-6 h-6 border-4 border-indigo-400 border-t-transparent border-solid rounded-full animate-spin"></div>
                    <p class="ml-3 text-indigo-600">AI æ­£åœ¨åŠªåŠ›åˆ†æä¸­...</p>
                </div>
            `;
            document.getElementById('analysisModalSources').classList.add('hidden');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeAnalysisModal() {
            document.getElementById('analysisModal').classList.add('hidden');
            document.getElementById('analysisModal').classList.remove('flex');
        }
        
        // --- æ–°å¢: Google æŸ¥åƒ¹ Modal æ§åˆ¶ ---
        function openSearchModal(symbol) {
            const modal = document.getElementById('searchModal');
            const iframe = document.getElementById('googleSearchIframe');
            
            // æ§‹å»º Google æœå°‹ URL
            const query = `${symbol} è‚¡åƒ¹`;
            const url = `https://www.google.com/search?q=${encodeURIComponent(query)}`;
            
            document.getElementById('searchModalTitle').innerText = `æŸ¥è©¢ ${symbol} å ±åƒ¹ (Google)`;
            iframe.src = url; // è¨­ç½® iframe ä¾†æº
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            showToast("Google æœå°‹é é¢å·²è¼‰å…¥ï¼Œè«‹æŸ¥çœ‹åƒ¹æ ¼ã€‚", "info", 4000);
        }

        function closeSearchModal() {
            const modal = document.getElementById('searchModal');
            const iframe = document.getElementById('googleSearchIframe');
            iframe.src = "about:blank"; // æ¸…é™¤ iframe å…§å®¹
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
        // --- End: Google æŸ¥åƒ¹ Modal æ§åˆ¶ ---


        // --- æ•¸æ“šæ“ä½œ ---
        function handleAssetSubmit(event) {
            event.preventDefault();
            const symbol = document.getElementById('inputSymbol').value.toUpperCase().trim();
            const market = document.getElementById('inputMarket').value;
            const shares = parseFloat(document.getElementById('inputShares').value);
            const cost = parseFloat(document.getElementById('inputCost').value);

            if (!symbol || isNaN(shares) || isNaN(cost) || shares <= 0 || cost < 0) {
                showToast("è«‹è¼¸å…¥æœ‰æ•ˆçš„ä»£è™Ÿã€è‚¡æ•¸å’Œæˆæœ¬", "error");
                return;
            }

            const existingIndex = APP_STATE.portfolio.findIndex(p => p.symbol === symbol);

            const newAsset = { symbol, market, shares, cost };

            if (existingIndex !== -1) {
                // ç·¨è¼¯ç¾æœ‰è³‡ç”¢
                APP_STATE.portfolio[existingIndex] = newAsset;
                showToast(`å·²æ›´æ–° ${symbol} çš„æŒè‚¡`, "success");
            } else {
                // æ–°å¢è³‡ç”¢
                APP_STATE.portfolio.push(newAsset);
                showToast(`å·²æ–°å¢ ${symbol} åˆ°æŒè‚¡åˆ—è¡¨`, "success");
            }

            savePortfolioToFirestore();
            render();
            closeAddModal();
        }

        function deleteAsset(symbol) {
            openDeleteConfirmModal(symbol);
        }

        function confirmDelete(symbol) {
            APP_STATE.portfolio = APP_STATE.portfolio.filter(p => p.symbol !== symbol);
            
            savePortfolioToFirestore();
            render();
            closeDeleteConfirmModal();
            showToast(`å·²åˆªé™¤ ${symbol} çš„æŒè‚¡ç´€éŒ„`, "warning");
        }

        /**
         * è™•ç†æ‰‹å‹•åƒ¹æ ¼è¼¸å…¥ï¼Œä¸¦å¯«å…¥å…¬å…± Firestore æ–‡ä»¶ä»¥ä¾›æ‰€æœ‰ç”¨æˆ¶å…±äº«ã€‚
         */
        async function saveManualPrice(symbol) {
            if (!db || !APP_STATE.isAuthReady) {
                showToast("è³‡æ–™åº«å°šæœªæº–å‚™å¥½ã€‚", "error");
                return;
            }
            
            const { doc, setDoc } = window.firebase;
            const priceInput = document.getElementById('manualPriceInput');
            const price = parseFloat(priceInput.value);

            if (isNaN(price) || price <= 0) {
                showToast("è«‹è¼¸å…¥æœ‰æ•ˆçš„åƒ¹æ ¼ (å¿…é ˆå¤§æ–¼ 0)", "error");
                return;
            }

            // ç¢ºä¿ä¸æœƒè¦†è“‹å…¶ä»–è‚¡ç¥¨çš„å…±äº«åƒ¹æ ¼
            const newPrices = { ...APP_STATE.prices };
            // å°‡åƒ¹æ ¼æ¨™è¨˜ç‚º Manual/å…±äº«ä¾†æº
            newPrices[symbol] = { price: price, source: 'Manual' };
            
            const pricesDocRef = doc(db, PUBLIC_PRICES_PATH, 'current');
            try {
                // é€é setDoc å¯«å…¥æ–°çš„åƒ¹æ ¼æ•¸æ“šåˆ°å…¬å…± Firestore æ–‡ä»¶ï¼Œå¯¦ç¾å…±äº«
                await setDoc(pricesDocRef, newPrices);
                
                // onSnapshot æœƒè‡ªå‹•æ›´æ–° APP_STATE.prices å’Œ UI
                closePriceModal();
                showToast(`${symbol} åƒ¹æ ¼å·²æ‰‹å‹•æ›´æ–°ä¸¦å…±äº«çµ¦æ‰€æœ‰ç”¨æˆ¶ã€‚`, "success");
            } catch (e) {
                console.error("Error saving manual price to Firestore:", e);
                showToast("æ‰‹å‹•æ›´æ–°åƒ¹æ ¼å¤±æ•—ã€‚", "error");
            }
        }
        
        // --- å¤–éƒ¨æŸ¥åƒ¹æ“ä½œ (æ”¹ç‚º Modal) ---
        function openGoogleSearch(symbol) {
            openSearchModal(symbol);
        }
        
        // --- AI åˆ†æåŠŸèƒ½ (ä»éœ€ API Key) ---

        async function analyzePortfolio() {
            if (API_KEY === "") {
                showToast("AI åˆ†æåŠŸèƒ½éœ€è¦ Gemini API Keyã€‚", "error");
                return;
            }
            openAnalysisModal("æŠ•è³‡çµ„åˆç¶œåˆåˆ†æ");
            
            const portfolioSummary = APP_STATE.portfolio.map(item => {
                const currentPrice = APP_STATE.prices[item.symbol]?.price || 'N/A';
                const marketValue = currentPrice !== 'N/A' 
                    ? (item.market === 'ç¾è‚¡' 
                        ? (currentPrice * item.shares * APP_STATE.exchangeRate) 
                        : (currentPrice * item.shares)
                    ).toFixed(0) : 'N/A';
                
                return `ä»£è™Ÿ: ${item.symbol}, å¸‚å ´: ${item.market}, è‚¡æ•¸: ${item.shares}, æˆæœ¬: ${item.cost}, ç¾åƒ¹: ${currentPrice}, å¸‚å€¼(TWD): ${marketValue}`;
            }).join('\n');

            const totalNetWorth = APP_STATE.portfolio.reduce((sum, item) => {
                const price = APP_STATE.prices[item.symbol]?.price || 0;
                const value = item.market === 'ç¾è‚¡' ? price * item.shares * APP_STATE.exchangeRate : price * item.shares;
                return sum + value;
            }, 0);
            
            const prompt = `Based on the following portfolio data, provide a professional, concise analysis focusing on diversification, risk, and potential next steps. Use traditional Chinese and keep the response under 200 words.
            
            Total Net Worth (TWD): ${Math.round(totalNetWorth).toLocaleString()}
            Portfolio Details:\n${portfolioSummary}
            
            Current Exchange Rate (USD/TWD): ${APP_STATE.exchangeRate}
            `;

            const systemInstruction = "æ‚¨æ˜¯ä¸€ä½ç¶“é©—è±å¯Œçš„é‡‘èåˆ†æå¸«ã€‚è«‹æ ¹æ“šæä¾›çš„æ•¸æ“šï¼Œç”¨ç°¡æ½”çš„ç¹é«”ä¸­æ–‡æä¾›å°ˆæ¥­çš„æŠ•è³‡çµ„åˆåˆ†æå ±å‘Šï¼Œå´é‡æ–¼é¢¨éšªèˆ‡å»ºè­°ã€‚è«‹åˆ†æ®µè½å‘ˆç¾ï¼Œä¸¦ä½¿ç”¨ Markdown æ ¼å¼ã€‚";

            const result = await callGemini(prompt, true, systemInstruction);
            
            document.getElementById('analysisModalContent').innerHTML = formatLLMResponse(result.text);
            updateAnalysisModalSources(result.sources);
        }

        async function openStockAnalysisModal(symbol) {
            if (API_KEY === "") {
                showToast("AI åˆ†æåŠŸèƒ½éœ€è¦ Gemini API Keyã€‚", "error");
                return;
            }
            openAnalysisModal(`${symbol} è‚¡ç¥¨åˆ†æ`);

            const item = APP_STATE.portfolio.find(p => p.symbol === symbol);
            const market = item.market === 'å°è‚¡' ? 'å°ç£è‚¡å¸‚' : 'ç¾åœ‹è‚¡å¸‚';
            
            const prompt = `Provide a brief fundamental and technical analysis summary for the stock ${symbol} traded in the ${market}. Include its current sector, recent news (if any), and a forward-looking outlook. Keep the analysis concise and under 150 words.`;
            
            const systemInstruction = "æ‚¨æ˜¯ä¸€ä½è³‡æ·±å¸‚å ´ç ”ç©¶å“¡ã€‚è«‹æ ¹æ“šæœ€æ–°çš„å¸‚å ´æ•¸æ“šï¼Œç”¨ç°¡æ½”çš„ç¹é«”ä¸­æ–‡ï¼Œé‡å°æŒ‡å®šè‚¡ç¥¨æä¾›åŸºæœ¬é¢å’ŒæŠ€è¡“é¢çš„æ‘˜è¦åˆ†æã€‚è«‹åˆ†æ®µè½å‘ˆç¾ï¼Œä¸¦ä½¿ç”¨ Markdown æ ¼å¼ã€‚";

            const result = await callGemini(prompt, true, systemInstruction);
            
            document.getElementById('analysisModalContent').innerHTML = formatLLMResponse(result.text);
            updateAnalysisModalSources(result.sources);
        }
        
        function formatLLMResponse(text) {
             // æ›¿æ› markdown æ¨™é¡Œç‚º HTML æ¨™é¡Œ
            text = text.replace(/^### (.*)$/gm, '<h4>$1</h4>');
            text = text.replace(/^## (.*)$/gm, '<h3>$1</h3>');
            text = text.replace(/^# (.*)$/gm, '<h2>$1</h2>');
            
            // æ›¿æ› markdown åˆ—è¡¨
            text = text.replace(/^\* (.*)$/gm, '<li>$1</li>');
            text = text.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
            
            // æ›¿æ› markdown ç²—é«” **X** æˆ– *X* ç‚º <strong>X</strong>
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
            
            // å°‡æ‰€æœ‰å–®å€‹æ›è¡Œç¬¦è½‰æ›ç‚º <br>
            text = text.replace(/\n/g, '<br>');
            
            // å°‡é€£çºŒçš„ <br><br> è½‰æ›ç‚ºæ®µè½é–“éš”ï¼Œé¿å…éå¤šç©ºé–“
            text = text.replace(/(<br>){3,}/g, '<br><br>');
            
            return text;
        }

        function updateAnalysisModalSources(sources) {
            const sourcesContainer = document.getElementById('analysisModalSources');
            const sourceList = document.getElementById('sourceList');
            sourceList.innerHTML = '';
            
            if (sources && sources.length > 0) {
                sourcesContainer.classList.remove('hidden');
                sources.slice(0, 3).forEach(source => { // åªé¡¯ç¤ºå‰ 3 å€‹ä¾†æº
                    const li = document.createElement('li');
                    li.innerHTML = `<a href="${source.uri}" target="_blank" class="text-indigo-500 hover:text-indigo-600 truncate block">${source.title}</a>`;
                    sourceList.appendChild(li);
                });
            } else {
                 sourcesContainer.classList.add('hidden');
            }
        }

        // --- è¨Šæ¯æç¤º ---
        function showToast(message, type = 'info', duration = 3000) {
            const toast = document.getElementById('toast');
            const toastMsg = document.getElementById('toastMsg');
            
            toastMsg.innerText = message;
            
            // æ¸…é™¤èˆŠçš„é¡è‰²é¡åˆ¥
            toast.classList.remove('bg-gray-800', 'bg-red-600', 'bg-green-600');
            
            // è¨­ç½®æ–°çš„é¡è‰²
            if (type === 'success') {
                toast.classList.add('bg-green-600');
            } else if (type === 'error' || type === 'warning') {
                toast.classList.add('bg-red-600');
            } else {
                toast.classList.add('bg-gray-800');
            }

            // é¡¯ç¤º toast
            toast.classList.remove('translate-x-full');
            
            // éš±è—
            setTimeout(() => {
                toast.classList.add('translate-x-full');
            }, duration);
        }

    </script>
</body>
</html>
